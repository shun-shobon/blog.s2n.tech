---
import "@/styles/markdown.css";

import { Image } from "astro:assets";
import { render } from "astro:content";
import { Icon } from "astro-icon/components";
import { joinURL } from "ufo";

import MyIcon from "@/assets/my-icon.png";
import Img from "@/components/Img.astro";
import PostItem from "@/components/PostItem.astro";
import Tag from "@/components/Tag.astro";
import Title from "@/components/Title.astro";
import BasicLayout from "@/layouts/BasicLayout.astro";
import { getPost, getPosts, postToSlug } from "@/libs/posts";

export async function getStaticPaths() {
	const { posts } = await getPosts({
		draft: import.meta.env.DEV,
	});

	return posts.map((post) => ({
		params: { slug: postToSlug(post) },
	}));
}

const { slug } = Astro.params;
if (!slug) {
	return Astro.rewrite("/404");
}

const post = await getPost(slug);
if (!post) {
	return Astro.rewrite("/404");
}

const intl = new Intl.DateTimeFormat("ja-JP");
const { Content, headings } = await render(post);

const { posts } = await getPosts({ draft: import.meta.env.DEV });
const latestPosts = posts
	.filter((latestPost) => latestPost.id !== post.id)
	.slice(0, 3);

// æœ€çµ‚æ›´æ–°æ—¥ã‹ã‚‰1å¹´ä»¥ä¸Šå¤ã„å ´åˆã¯ã€å¹´æ•°ã‚’è¡¨ç¤ºã™ã‚‹(æ›´æ–°ãŒãªã„å ´åˆã¯å…¬é–‹æ—¥)
const lastUpdatedAt = post.data.updatedAt ?? post.data.publishedAt;
const yearsSinceUpdatedAt =
	lastUpdatedAt != null
		? Math.floor(
				(Date.now() - new Date(lastUpdatedAt).getTime()) /
					(1000 * 60 * 60 * 24 * 365),
			)
		: null;
---

<BasicLayout
	title={post.data.title}
	description={null}
	ogImage={joinURL("posts", slug, "og-image.png")}
	ogImageType="large"
>
	<article class="px-0 pb-4 sm:px-8 sm:pb-8">
		<div
			class="mx-auto grid w-full max-w-4xl justify-center gap-2 px-4 sm:gap-4 sm:px-0"
		>
			<Title>{post.data.title}</Title>
			<div class="text-center text-sm text-text-secondary">
				{
					post.data.publishedAt ? (
						<>
							<time datetime={new Date(post.data.publishedAt).toISOString()}>
								{intl.format(new Date(post.data.publishedAt))}
							</time>
							å…¬é–‹
						</>
					) : (
						<>æœªå…¬é–‹</>
					)
				}
				{
					post.data.updatedAt ? (
						<>
							ãƒ»
							<time datetime={new Date(post.data.updatedAt).toISOString()}>
								{intl.format(new Date(post.data.updatedAt))}
							</time>
							æ›´æ–°
						</>
					) : null
				}
			</div>
			<div class="flex flex-wrap justify-center gap-2">
				{post.data.tags.map((tag) => <Tag tag={tag} />)}
			</div>
		</div>
		<div class="mx-auto flex items-start justify-center gap-4 pt-4 sm:pt-8">
			<div class="grid w-full max-w-4xl gap-4 sm:gap-8">
				<div
					class="markdown max-w-none min-w-0 rounded-2xl border border-border-primary bg-background-primary p-4 shadow-none sm:px-8 sm:py-6 sm:shadow-lg"
				>
					{
						yearsSinceUpdatedAt != null && yearsSinceUpdatedAt > 0 && (
							<aside class="not-markdown my-4 flex items-center gap-1 rounded-lg border border-warn-border bg-warn-background px-2 py-2 font-bold text-warn-text sm:px-4">
								<Icon name="lucide:triangle-alert" class="size-4 shrink-0" />
								<p>
									ã“ã®è¨˜äº‹ã¯æœ€çµ‚æ›´æ–°æ—¥ã‹ã‚‰{yearsSinceUpdatedAt}
									å¹´ä»¥ä¸ŠãŒçµŒéã—ã¦ã„ã¾ã™ã€‚
								</p>
							</aside>
						)
					}
					<Content components={{ img: Img }} />
				</div>
				<div
					class="grid gap-4 rounded-2xl border border-border-primary bg-background-primary p-4 shadow-none sm:px-8 sm:py-6 sm:shadow-lg"
				>
					<p class="sr-only">æ›¸ã„ãŸäºº</p>
					<div class="flex items-center gap-4">
						<Image
							src={MyIcon}
							alt=""
							widths={[80, 160]}
							sizes="80px"
							class="size-20 rounded-full border border-border-primary"
						/>
						<div class="flex flex-col gap-2">
							<div class="flex flex-col">
								<a
									href="https://s2n.tech/"
									target="_blank"
									class="text-lg font-bold">ã—ã‚…ã‚“ğŸŒ™</a
								>
								<a href="https://s2n.tech/" target="_blank" class="text-xs"
									>@shun_shobon</a
								>
							</div>
							<div class="flex gap-2">
								<a
									href="https://github.com/shun-shobon"
									target="_blank"
									class="text-text-secondary transition-colors hover:text-text-primary"
								>
									<Icon
										name="simple-icons:github"
										class="size-5"
										title="GitHub"
									/>
								</a>
								<a
									href="https://x.com/shun_shobon"
									target="_blank"
									class="text-text-secondary transition-colors hover:text-text-primary"
								>
									<Icon name="simple-icons:x" class="size-5" title="X" />
								</a>
							</div>
						</div>
					</div>
				</div>
				<div
					class="grid gap-4 rounded-2xl border border-border-primary bg-background-primary p-4 shadow-none sm:px-8 sm:py-6 sm:shadow-lg"
				>
					<div class="text-xl font-bold kerning-on">æœ€æ–°è¨˜äº‹</div>
					<div>
						{latestPosts.map((post) => <PostItem post={post} />)}
					</div>
				</div>
			</div>
			{
				headings.length > 0 && (
					<div class="sticky top-8 hidden max-h-[calc(100dvh-var(--spacing)*16)] w-full max-w-xs gap-2 overflow-y-auto rounded-2xl border border-border-primary bg-background-primary p-4 shadow-none sm:shadow-lg xl:grid">
						<div class="text-lg font-bold kerning-on">ç›®æ¬¡</div>
						<ul
							class:list={[
								"relative pl-2 text-sm leading-normal text-text-secondary",
								"before:absolute before:top-[0.5lh] before:h-[calc(100%-1lh)] before:w-px before:-translate-x-1/2",
								"before:bg-border-tertiary",
							]}
						>
							{headings
								.filter((heading) => heading.depth < 5)
								.map((heading) => (
									<li
										class:list={[
											"group relative",
											"before:absolute before:top-[0.5lh] before:left-0 before:mr-1 before:-translate-x-1/2 before:-translate-y-1/2 before:rounded-full before:border-[3px]",
											"before:border-background-primary before:bg-border-tertiary before:transition-colors hover:before:bg-text-secondary",
											heading.depth === 2 && "font-bold before:size-[12px]",
											heading.depth === 3 && "before:size-[10px]",
											heading.depth === 4 && "before:size-[8px]",
										]}
									>
										<a
											href={`#${heading.slug}`}
											class:list={[
												"block transition-colors group-hover:text-text-primary",
												heading.depth === 2 && "pl-3",
												heading.depth === 3 && "pl-5",
												heading.depth === 4 && "pl-7",
											]}
										>
											{heading.text}
										</a>
									</li>
								))}
						</ul>
					</div>
				)
			}
		</div>
	</article>
</BasicLayout>
